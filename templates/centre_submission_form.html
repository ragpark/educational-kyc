{% extends "base.html" %}
{% block title %}Qualification Approval{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Course and qualification selection</h2>
        <p class="text-gray-600">Using the OFQUAL register select the courses and qualifications you want to offer. Upon submission your application will route to the correct AO.</p>
    </div>
    <form method="POST" action="/centre-submission" class="bg-white rounded-lg shadow-md p-8 space-y-6">
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Application or Verification details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="group_ukprn">Verification ID from your compliance check</label>
                    <input type="text" id="verification_id" name="verification_id" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., 12345678">
                    <div id="verification-status" class="mt-2 text-xs text-red-600 hidden"></div>
                </div>
            </div>
        </div>
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Qualification Requested</h3>
            <a href="/ofqual/search" class="text-sm text-blue-600 underline">Search Ofqual Register</a>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="qualification_id">Qualification ID</label>
                    <input type="text" id="qualification_id" name="qualification_id" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="ao_id">Awarding Org ID</label>
                    <input type="text" id="ao_id" name="ao_id" value="{{ organisation_id or '' }}" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="ao_name">Awarding Org Name</label>
                    <input type="text" id="ao_name" name="ao_name" value="{{ organisation_name or '' }}" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="title">Qualification Title</label>
                    <input type="text" id="title" name="title" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="start_date">Start Date</label>
                    <input type="date" id="start_date" name="start_date" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="cohort_size">Expected Cohort Size</label>
                    <input type="number" id="cohort_size" name="cohort_size" required class="w-full border border-gray-300 rounded-md px-3 py-2" min="1">
                </div>
            </div>
        </div>
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Approval Contact </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="staff_id">Staff ID</label>
                    <input type="text" id="staff_id" name="staff_id" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="staff_role">Role</label>
                    <input type="text" id="staff_role" name="staff_role" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="staff_name">Name</label>
                    <input type="text" id="staff_name" name="staff_name" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="staff_email">Email</label>
                    <input type="email" id="staff_email" name="staff_email" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
            </div>
        </div>
        <div class="pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Compliance Declarations</h3>
            <div class="space-y-3">
                <div class="flex items-center">
                    <input id="ofqual_ack" name="ofqual_ack" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="ofqual_ack" class="ml-2 block text-sm text-gray-700">Ofqual conditions acknowledged</label>
                </div>
                <div class="flex items-center">
                    <input id="gdpr_consent" name="gdpr_consent" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="gdpr_consent" class="ml-2 block text-sm text-gray-700">GDPR consent</label>
                </div>
                <div class="flex items-center">
                    <input id="share_aos" name="share_aos" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="share_aos" class="ml-2 block text-sm text-gray-700">Share this data with appropriate AOs confirmed</label>
                </div>
            </div>
        </div>
        <div class="pt-6 flex justify-between">
            <a href="/" class="text-gray-600 hover:text-gray-800">‚Üê Back to Dashboard</a>
            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-md hover:bg-blue-700">Add to application pack</button>
        </div>
    </form>
</div>
<script>
// Disable all form fields until verification ID is validated
const verificationInput = document.getElementById('verification_id');
const statusEl = document.getElementById('verification-status');
const formEl = document.querySelector('form');
const otherFields = Array.from(formEl.querySelectorAll('input, select, textarea, button'))
    .filter(el => el.id !== 'verification_id');

function disableOthers(disabled) {
    otherFields.forEach(el => {
        if (el.type !== 'submit') {
            el.disabled = disabled;
        } else if (disabled) {
            el.disabled = true;
        }
    });
}

let verifyTimeout;
disableOthers(true);

verificationInput.addEventListener('input', function(e) {
    const value = e.target.value.trim();
    clearTimeout(verifyTimeout);
    statusEl.classList.add('hidden');
    statusEl.textContent = '';
    disableOthers(true);

    if (!value) {
        return;
    }

    verifyTimeout = setTimeout(async () => {
        try {
            statusEl.classList.remove('text-red-600', 'text-green-600');
            statusEl.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>';
            statusEl.classList.remove('hidden');
            const resp = await fetch(`/verification/${encodeURIComponent(value)}`);
            const data = await resp.json();
            if (!data.error) {
                if (data.revoked) {
                    statusEl.classList.add('text-red-600');
                    const reason = data.revocation_reason ? `: ${data.revocation_reason}` : '';
                    statusEl.textContent = `Verification ID revoked${reason}`;
                    disableOthers(true);
                } else {
                    statusEl.classList.add('text-green-600');
                    statusEl.textContent = 'Verification ID confirmed';
                    disableOthers(false);
                }
            } else {
                statusEl.classList.add('text-red-600');
                statusEl.textContent = 'Invalid Verification ID';
            }
        } catch (_) {
            statusEl.classList.add('text-red-600');
            statusEl.textContent = 'Unable to verify ID';
        }
    }, 500);
});
</script>
{% endblock %}
