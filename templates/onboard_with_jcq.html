{% extends "base.html" %}
{% block title %}Provider Onboarding{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Educational Provider Onboarding</h2>
        <p class="text-gray-600">Legal and compliance checks to become an approved educational provider</p>
        <h4 class="text-3xl text-gray-900 mb-2">About this step</h4>
        <p class="text-gray-600">Please provide your Centre's details. Failure to provide details will result in a delayed or suspended application.</p>
    </div>
    
    <form method="POST" action="/onboard" class="bg-white rounded-lg shadow-md p-8 space-y-6">
        <!-- Organisation Information -->
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Organisation Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="organisation_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Organisation Name *
                    </label>
                    <input type="text" id="organisation_name" name="organisation_name" required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Your organisation's legal name">
                </div>
                
                <div>
                    <label for="trading_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Trading Name
                    </label>
                    <input type="text" id="trading_name" name="trading_name"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Trading name (if different)">
                </div>
                
                <div>
                    <label for="provider_type" class="block text-sm font-medium text-gray-700 mb-2">
                        Provider Type *
                    </label>
                    <select id="provider_type" name="provider_type" required
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select provider type...</option>
                        <option value="Training Provider">Training Provider</option>
                        <option value="FE College">Further Education College</option>
                        <option value="HE Institution">Higher Education Institution</option>
                        <option value="Apprenticeship Provider">Apprenticeship Provider</option>
                        <option value="Private Training">Private Training Provider</option>
                        <option value="Adult Community">Adult & Community Learning</option>
                    </select>
                </div>
                
                <div>
                    <label for="contact_email" class="block text-sm font-medium text-gray-700 mb-2">
                        Contact Email *
                    </label>
                    <input type="email" id="contact_email" name="contact_email" required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="contact@organisation.com">
                </div>
            </div>
        </div>

        <!-- Registration Details -->
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Registration Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="company_number" class="block text-sm font-medium text-gray-700 mb-2">
                        Company Number *
                    </label>
                    <input type="text" id="company_number" name="company_number" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., 12345678"
                           pattern="[0-9]{8}"
                           title="Company number should be 8 digits">
                    <p class="text-xs text-gray-500 mt-1">8-digit Companies House number</p>
                </div>
                
                <div>
                    <label for="urn" class="block text-sm font-medium text-gray-700 mb-2">
                        URN (Unique Reference Number) *
                    </label>
                    <div class="relative">
                        <input type="text" id="urn" name="urn" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., 123456"
                               pattern="[0-9]{6,7}"
                               title="URN should be 6-7 digits">
                        <div id="urn-status" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <!-- Status indicator will be inserted here -->
                        </div>
                    </div>
                    <div id="urn-info" class="mt-2 text-xs text-gray-600 hidden">
                        <!-- URN information will be displayed here -->
                    </div>
                    <div id="urn-error" class="mt-2 text-xs text-red-600 hidden">
                        <!-- Error messages will be displayed here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Ofsted Unique Reference Number (6-7 digits). Required for automated Ofsted verification.
                        <a href="https://reports.ofsted.gov.uk/search" target="_blank" class="text-blue-600 hover:text-blue-800">
                            Find your URN on the Ofsted website →
                        </a>
                    </p>
                </div>
                
                <div>
                    <label for="ukprn" class="block text-sm font-medium text-gray-700 mb-2">
                        UKPRN (Optional)
                    </label>
                    <div class="relative">
                        <input type="text" id="ukprn" name="ukprn"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., 10012345"
                               pattern="10[0-9]{6}"
                               title="UKPRN should start with 10 followed by 6 digits">
                        <div id="ukprn-status" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <!-- Status indicator will be inserted here -->
                        </div>
                    </div>
                    <div id="ukprn-info" class="mt-2 text-xs text-gray-600 hidden">
                        <!-- UKPRN information will be displayed here -->
                    </div>
                    <div id="ukprn-error" class="mt-2 text-xs text-red-600 hidden">
                        <!-- Error messages will be displayed here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-1">UK Provider Reference Number (if applicable)</p>
                </div>
        
                <!--<div>
                    <label for="qualifications_offered" class="block text-sm font-medium text-gray-700 mb-2">
                        Qualifications Sought
                    </label>
                    <input type="text" id="qualifications_offered" name="qualifications_offered"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., GCSE, A-Level, BTEC (comma-separated)">
                    <p class="text-xs text-gray-500 mt-1">List main qualifications you want to offer, separated by commas</p>
                </div>-->
            </div>
        </div>

        <!-- Address Information -->
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Address Information</h3>
            <div class="space-y-4">
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                        Address *
                    </label>
                    <textarea id="address" name="address" required rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Full address including street, city/town"></textarea>
                </div>
                
                <div class="max-w-md">
                    <label for="postcode" class="block text-sm font-medium text-gray-700 mb-2">
                        Postcode *
                    </label>
                    <div class="relative">
                        <input type="text" id="postcode" name="postcode" required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., SW1A 1AA">
                        <div id="postcode-status" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <!-- Status indicator will be inserted here -->
                        </div>
                    </div>
                    <div id="postcode-info" class="mt-2 text-xs text-gray-600 hidden">
                        <!-- Postcode information will be displayed here -->
                    </div>
                    <div id="postcode-error" class="mt-2 text-xs text-red-600 hidden">
                        <!-- Error messages will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- API Status Information -->
        {% if api_status %}
        <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="text-sm font-medium text-gray-900 mb-2">Verification Services Status</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2 {% if api_status.companies_house_api %}bg-green-400{% else %}bg-red-400{% endif %}"></div>
                    <span>Companies House API: {% if api_status.companies_house_api %}Active{% else %}Limited{% endif %}</span>
                </div>
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2 bg-green-400"></div>
                    <span>Postcode Validation: Active</span>
                </div>
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2 {% if api_status.orchestrator_available %}bg-green-400{% else %}bg-red-400{% endif %}"></div>
                    <span>Educational KYC: {% if api_status.orchestrator_available %}Active{% else %}Limited{% endif %}</span>
                </div>
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2 {% if api_status.jcq_simulation %}bg-blue-400{% else %}bg-red-400{% endif %}"></div>
                    <span>JCQ Verification: {% if api_status.jcq_simulation %}Simulation{% else %}Unavailable{% endif %}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Submit Button -->
        <div class="pt-6">
            <div class="flex justify-between items-center">
                <a href="/" class="text-gray-600 hover:text-gray-800">
                    ← Back to Dashboard
                </a>
                <button type="submit" id="submit-btn"
                        class="bg-blue-600 text-white px-8 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Submit Application
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Real-time postcode validation
let postcodeTimeout;
const postcodeInput = document.getElementById('postcode');
const postcodeStatus = document.getElementById('postcode-status');
const postcodeInfo = document.getElementById('postcode-info');
const postcodeError = document.getElementById('postcode-error');

function showPostcodeStatus(type, content) {
    postcodeStatus.innerHTML = content;
    
    if (type === 'loading') {
        postcodeInfo.classList.add('hidden');
        postcodeError.classList.add('hidden');
    } else if (type === 'success') {
        postcodeError.classList.add('hidden');
        postcodeInfo.classList.remove('hidden');
    } else if (type === 'error') {
        postcodeInfo.classList.add('hidden');
        postcodeError.classList.remove('hidden');
    }
}

postcodeInput.addEventListener('input', function(e) {
    const postcode = e.target.value.trim();
    
    // Clear previous timeout
    clearTimeout(postcodeTimeout);
    
    // Clear status
    showPostcodeStatus('', '');
    
    // Skip validation if postcode is too short
    if (postcode.length < 5) {
        return;
    }
    
    // Debounce validation
    postcodeTimeout = setTimeout(async () => {
        try {
            // Show loading
            showPostcodeStatus('loading', `
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
            `);
            
            // Call validation API
            const response = await fetch(`/postcode/validate/${encodeURIComponent(postcode)}`);
            const data = await response.json();
            
            if (data.valid) {
                // Show success
                showPostcodeStatus('success', `
                    <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                // Show postcode info
                postcodeInfo.innerHTML = `
                    <strong>Valid UK Postcode:</strong> ${data.postcode}<br>
                    ${data.admin_district ? `<strong>District:</strong> ${data.admin_district}<br>` : ''}
                    ${data.admin_county ? `<strong>County:</strong> ${data.admin_county}<br>` : ''}
                    ${data.region ? `<strong>Region:</strong> ${data.region}` : ''}
                `;
                
                // Update input with formatted postcode
                if (data.postcode && data.postcode !== postcode) {
                    postcodeInput.value = data.postcode;
                }
                
            } else {
                // Show error
                showPostcodeStatus('error', `
                    <svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                postcodeError.textContent = data.error || 'Invalid postcode';
            }
            
        } catch (error) {
            // Show error
            showPostcodeStatus('error', `
                <svg class="h-4 w-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            `);
            
            postcodeError.textContent = 'Unable to validate postcode. Please check your connection.';
        }
    }, 500); // Wait 500ms after user stops typing
});

// Real-time URN validation
let urnTimeout;
const urnInput = document.getElementById('urn');
const urnStatus = document.getElementById('urn-status');
const urnInfo = document.getElementById('urn-info');
const urnError = document.getElementById('urn-error');

function showUrnStatus(type, content) {
    urnStatus.innerHTML = content;
    
    if (type === 'loading') {
        urnInfo.classList.add('hidden');
        urnError.classList.add('hidden');
    } else if (type === 'success') {
        urnError.classList.add('hidden');
        urnInfo.classList.remove('hidden');
    } else if (type === 'error') {
        urnInfo.classList.add('hidden');
        urnError.classList.remove('hidden');
    }
}

urnInput.addEventListener('input', function(e) {
    const urn = e.target.value.trim();
    
    // Clear previous timeout
    clearTimeout(urnTimeout);
    
    // Clear status
    showUrnStatus('', '');
    
    // Skip validation if URN is too short
    if (urn.length < 6) {
        return;
    }
    
    // Debounce validation
    urnTimeout = setTimeout(async () => {
        try {
            // Show loading
            showUrnStatus('loading', `
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
            `);
            
            // Call validation API
            const response = await fetch(`/urn/validate/${encodeURIComponent(urn)}`);
            const data = await response.json();
            
            if (data.valid) {
                // Show success
                showUrnStatus('success', `
                    <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                // Show URN info
                urnInfo.innerHTML = `
                    <strong>Valid Ofsted URN:</strong> ${data.urn}<br>
                    <strong>Status:</strong> ${data.message}<br>
                    <a href="${data.ofsted_url}" target="_blank" class="text-blue-600 hover:text-blue-800">View Ofsted Report →</a>
                `;
                
            } else {
                // Show error
                showUrnStatus('error', `
                    <svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                urnError.textContent = data.error || 'Invalid URN';
            }
            
        } catch (error) {
            // Show error
            showUrnStatus('error', `
                <svg class="h-4 w-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            `);
            
            urnError.textContent = 'Unable to validate URN. Please check your connection.';
        }
    }, 750); // Wait 750ms after user stops typing (slightly longer for URN)
});

// Real-time UKPRN validation
let ukprn_timeout;
const ukprn_input = document.getElementById('ukprn');
const ukprn_status = document.getElementById('ukprn-status');
const ukprn_info = document.getElementById('ukprn-info');
const ukprn_error = document.getElementById('ukprn-error');

function showUkprnStatus(type, content) {
    ukprn_status.innerHTML = content;
    
    if (type === 'loading') {
        ukprn_info.classList.add('hidden');
        ukprn_error.classList.add('hidden');
    } else if (type === 'success') {
        ukprn_error.classList.add('hidden');
        ukprn_info.classList.remove('hidden');
    } else if (type === 'error') {
        ukprn_info.classList.add('hidden');
        ukprn_error.classList.remove('hidden');
    }
}

ukprn_input.addEventListener('input', function(e) {
    const ukprn = e.target.value.trim();
    
    // Clear previous timeout
    clearTimeout(ukprn_timeout);
    
    // Clear status
    showUkprnStatus('', '');
    
    // Skip validation if UKPRN is empty (it's optional)
    if (ukprn.length === 0) {
        return;
    }
    
    // Skip validation if UKPRN is too short
    if (ukprn.length < 8) {
        return;
    }
    
    // Debounce validation
    ukprn_timeout = setTimeout(async () => {
        try {
            // Show loading
            showUkprnStatus('loading', `
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
            `);
            
            // Call validation API
            const response = await fetch(`/ukprn/validate/${encodeURIComponent(ukprn)}`);
            const data = await response.json();
            
            if (data.valid) {
                // Show success
                showUkprnStatus('success', `
                    <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                // Show UKPRN info
                ukprn_info.innerHTML = `
                    <strong>Valid UKPRN:</strong> ${data.ukprn}<br>
                    <strong>Provider:</strong> ${data.provider_name}<br>
                    <strong>Status:</strong> ${data.verification_status} / ${data.provider_status}
                `;
                
            } else {
                // Show error
                showUkprnStatus('error', `
                    <svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                `);
                
                ukprn_error.textContent = data.error || 'Invalid UKPRN';
            }
            
        } catch (error) {
            // Show error
            showUkprnStatus('error', `
                <svg class="h-4 w-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            `);
            
            ukprn_error.textContent = 'Unable to validate UKPRN. Please check your connection.';
        }
    }, 750); // Wait 750ms after user stops typing
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submit-btn');
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
            Submitting...
        </div>
    `;
});
</script>
{% endblock %}
