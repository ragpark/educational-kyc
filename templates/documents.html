{% extends "base.html" %}
{% block title %}Documents{% endblock %}
{% block content %}
{% if user %}
<p class="text-sm text-gray-600 mb-2">Logged in as {{ user.name }} ({{ user.role.replace('_',' ')|title }})</p>
{% endif %}

<h1 class="text-2xl font-bold mb-4">Document Repository</h1>

<form id="uploadForm" class="space-y-4" enctype="multipart/form-data">
    <input type="file" id="fileInput" name="files" multiple class="border rounded w-full px-3 py-2">
    <div class="flex space-x-2">
        <button type="button" id="gdriveBtn" class="bg-red-600 text-white px-3 py-2 rounded">Google Drive</button>
        <button type="button" id="onedriveBtn" class="bg-blue-600 text-white px-3 py-2 rounded">OneDrive</button>
    </div>
    <div class="w-full bg-gray-200 rounded h-2">
        <div id="progressBar" class="bg-blue-600 h-2 w-0 rounded"></div>
    </div>
    <p id="progressText" class="text-sm"></p>
    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Upload</button>
</form>

<h2 class="text-xl font-semibold mt-8 mb-2">Your Documents</h2>
<div class="overflow-x-auto">
    <table class="min-w-full bg-white divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doc ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Format</th>
                <th class="px-4 py-2"></th>
                <th class="px-4 py-2"></th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for doc in documents %}
            <tr>
                <td class="px-4 py-2 text-sm text-gray-900">{{ loop.index }}</td>
                <td class="px-4 py-2 text-sm"><a href="/static/uploads/{{ doc.stored_name }}" class="text-blue-600 hover:underline">{{ doc.name }}</a></td>
                <td class="px-4 py-2 text-sm text-gray-500">{{ doc.name.split('.')[-1].upper() }}</td>
                <td class="px-4 py-2 text-center">
                    <a href="#" title="Attach to application" class="text-indigo-600 hover:text-indigo-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.364 6.364a4 4 0 105.656 5.656l6.364-6.364a4 4 0 00-5.656-5.656L9 10.828" />
                        </svg>
                    </a>
                </td>
                <td class="px-4 py-2 text-center">
                    <a href="#" title="Share by email" class="text-indigo-600 hover:text-indigo-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="uploadResult" class="mt-4 text-sm"></div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://js.live.net/v7.2/OneDrive.js"></script>
<script>
let externalFiles = [];

// Google Drive picker placeholder
function loadDrivePicker() {
    // Requires OAuth token configuration
    // This function should use google.picker.PickerBuilder to allow file selection
}

document.getElementById('gdriveBtn').addEventListener('click', loadDrivePicker);

// OneDrive picker placeholder
function loadOneDrivePicker() {
    // Requires OneDrive client ID configuration
    // This function should call OneDrive.open with the required options
}

document.getElementById('onedriveBtn').addEventListener('click', loadOneDrivePicker);

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData();
    const files = document.getElementById('fileInput').files;
    for (const file of files) {
        formData.append('files', file);
    }
    for (const file of externalFiles) {
        formData.append('files', file);
    }
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/documents/upload');
    xhr.upload.onprogress = function(evt) {
        if (evt.lengthComputable) {
            const percent = (evt.loaded / evt.total) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent.toFixed(0) + '%';
        }
    };
    xhr.onload = function() {
        document.getElementById('uploadResult').textContent = xhr.responseText;
        document.getElementById('progressBar').style.width = '0';
        document.getElementById('progressText').textContent = '';
        document.getElementById('uploadForm').reset();
        externalFiles = [];
    };
    xhr.send(formData);
});
</script>
{% endblock %}
